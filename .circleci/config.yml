version: 2.1

orbs:
  node: circleci/node@5.1.0

jobs:
  test-backend:
    docker:
      - image: cimg/node:18.17
    working_directory: ~/project
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: backend
      - run:
          name: Run backend tests
          command: |
            cd backend
            npm test || echo "No tests configured yet"

  test-frontend:
    docker:
      - image: cimg/node:18.17
    working_directory: ~/project
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: frontend
      - run:
          name: Build frontend
          command: |
            cd frontend
            npm run build

  deploy:
    docker:
      - image: cimg/node:18.17
    steps:
      - checkout
      - run:
          name: Deploy to Render
          command: |
            echo "Deployment triggered via Render webhook"
            # Render auto-deploys on push to main branch

  build-docker:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Create dummy .env
          command: |
            echo "DATABASE_URL=postgresql://user:pass@localhost:5432/db" > backend/.env
      - run:
          name: Build Docker containers
          command: |
            docker-compose build

workflows:
  version: 2
  test-and-deploy:
    jobs:
      - test-backend
      - test-frontend
      - build-docker
      - deploy:
          requires:
            - test-backend
            - test-frontend
            - build-docker
          filters:
            branches:
              only: main
